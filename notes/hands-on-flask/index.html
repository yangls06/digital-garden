<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Flask上手 Reference  Flask Installation
 Flask Tutorial
Follow the tutorial to build a blog web app like:
 Step by Step Step 0."><title>Flask上手</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://yangls06.github.io/digital-garden//icon.png><link href=https://yangls06.github.io/digital-garden/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://yangls06.github.io/digital-garden/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://yangls06.github.io/digital-garden/js/darkmode.aa0630d04550405b827df945275af6c3.min.js></script>
<script src=https://yangls06.github.io/digital-garden/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://yangls06.github.io/digital-garden/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://yangls06.github.io/digital-garden/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://yangls06.github.io/digital-garden/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://yangls06.github.io/digital-garden/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://yangls06.github.io/digital-garden/",fetchData=Promise.all([fetch("https://yangls06.github.io/digital-garden/indices/linkIndex.3c2aebe255e03997a164c3e6606c163d.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://yangls06.github.io/digital-garden/indices/contentIndex.ee7f9e6f9ff48ac94dfb632b38bb8161.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://yangls06.github.io/digital-garden",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://yangls06.github.io/digital-garden",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/yangls06.github.io\/digital-garden\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://yangls06.github.io/digital-garden/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://yangls06.github.io/digital-garden/>🪴 无人之路</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Flask上手</h1><p class=meta>Last updated
Dec 2, 2022
<a href=https://github.com/yangls06/digital-garden/tree/hugo/content/notes/hands-on-flask.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://yangls06.github.io/digital-garden/tags/setup/>Setup</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#reference>Reference</a></li><li><a href=#step-by-step>Step by Step</a><ol><li><a href=#step-0backgroud>Step 0.Backgroud</a></li><li><a href=#step-1-project-layout>Step 1. Project Layout</a></li><li><a href=#step-3-application-setup>Step 3. Application Setup</a></li><li><a href=#step-4-define-and-access-the-database>Step 4. Define and Access the Database</a></li><li><a href=#step-5-blueprints-and-views>Step 5. Blueprints and Views</a></li><li><a href=#step-6-templates>Step 6. Templates</a></li></ol></li></ol></nav></details></aside><a href=#flask上手><h1 id=flask上手><span class=hanchor arialabel=Anchor># </span>Flask上手</h1></a><a href=#reference><h2 id=reference><span class=hanchor arialabel=Anchor># </span>Reference</h2></a><p><a href=https://flask.palletsprojects.com/en/2.2.x/installation/ rel=noopener>Flask Installation</a></p><p><a href=https://flask.palletsprojects.com/en/2.2.x/tutorial/ rel=noopener>Flask Tutorial</a></p><p>Follow the tutorial to build a blog web app like:</p><p><img src=https://happy3-data.oss-cn-hangzhou.aliyuncs.com/content-images/image-20221201145000837.png width=auto alt=image-20221201145000837></p><a href=#step-by-step><h2 id=step-by-step><span class=hanchor arialabel=Anchor># </span>Step by Step</h2></a><a href=#step-0backgroud><h3 id=step-0backgroud><span class=hanchor arialabel=Anchor># </span>Step 0.Backgroud</h3></a><p>build a basic blog application called Flaskr using Flask.</p><a href=#step-1-project-layout><h3 id=step-1-project-layout><span class=hanchor arialabel=Anchor># </span>Step 1. Project Layout</h3></a><a href=#create-a-project-directory><h4 id=create-a-project-directory><span class=hanchor arialabel=Anchor># </span>Create a project directory</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir flask-tutorial
</span></span><span class=line><span class=cl><span class=nb>cd</span> flask-tutorial/
</span></span></code></pre></td></tr></table></div></div><a href=#install-flask><h4 id=install-flask><span class=hanchor arialabel=Anchor># </span>Install Flask</h4></a><p><a href=https://flask.palletsprojects.com/en/2.2.x/installation/ rel=noopener>Flask Installation Doc</a></p><p>Create an python environment using
<a href=https://docs.python.org/3/library/venv.html#module-venv rel=noopener>venv</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python3 -m venv venv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ tree . -L <span class=m>3</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>└── venv
</span></span><span class=line><span class=cl>    ├── bin
</span></span><span class=line><span class=cl>    │   ├── Activate.ps1
</span></span><span class=line><span class=cl>    │   ├── activate
</span></span><span class=line><span class=cl>    │   ├── activate.csh
</span></span><span class=line><span class=cl>    │   ├── activate.fish
</span></span><span class=line><span class=cl>    │   ├── pip
</span></span><span class=line><span class=cl>    │   ├── pip3
</span></span><span class=line><span class=cl>    │   ├── pip3.9
</span></span><span class=line><span class=cl>    │   ├── python -&gt; python3
</span></span><span class=line><span class=cl>    │   ├── python3 -&gt; /Users/yangls06/opt/miniconda3/bin/python3
</span></span><span class=line><span class=cl>    │   └── python3.9 -&gt; python3
</span></span><span class=line><span class=cl>    ├── include
</span></span><span class=line><span class=cl>    ├── lib
</span></span><span class=line><span class=cl>    │   └── python3.9
</span></span><span class=line><span class=cl>    └── pyvenv.cfg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>5</span> directories, <span class=m>11</span> files
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ tree venv/lib/python3.9/ -L <span class=m>3</span>
</span></span><span class=line><span class=cl>venv/lib/python3.9/
</span></span><span class=line><span class=cl>└── site-packages
</span></span><span class=line><span class=cl>    ├── _distutils_hack
</span></span><span class=line><span class=cl>    │   ├── __init__.py
</span></span><span class=line><span class=cl>    │   ├── __pycache__
</span></span><span class=line><span class=cl>    │   └── override.py
</span></span><span class=line><span class=cl>    ├── distutils-precedence.pth
</span></span><span class=line><span class=cl>    ├── pip
</span></span><span class=line><span class=cl>    │   ├── __init__.py
</span></span><span class=line><span class=cl>    │   ├── __main__.py
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>    ├── pkg_resources
</span></span><span class=line><span class=cl>    ...
</span></span></code></pre></td></tr></table></div></div><p>Activate the environment</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ . venv/bin/activate
</span></span></code></pre></td></tr></table></div></div><p>Then the environment has been changed.</p><p><img src=https://happy3-data.oss-cn-hangzhou.aliyuncs.com/content-images/image-20221201153333547.png width=auto alt=image-20221201153333547></p><p>Install Flask</p><p>Within the activated environment, install Flask using <code>pip</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ pip install Flask
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Looking in indexes: https://pypi.douban.com/simple
</span></span><span class=line><span class=cl>Collecting Flask
</span></span><span class=line><span class=cl>  Downloading https://pypi.doubanio.com/packages/0f/43/15f4f9ab225b0b25352412e8daa3d0e3d135fcf5e127070c74c3632c8b4c/Flask-2.2.2-py3-none-any.whl <span class=o>(</span><span class=m>101</span> kB<span class=o>)</span>
</span></span><span class=line><span class=cl>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 101.5/101.5 KB 1.8 MB/s eta 0:00:00
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Collecting MarkupSafe&gt;<span class=o>=</span>2.0
</span></span><span class=line><span class=cl>  Downloading https://pypi.doubanio.com/packages/06/7f/d5e46d7464360b6ac39c5b0b604770dba937e3d7cab485d2f3298454717b/MarkupSafe-2.1.1-cp39-cp39-macosx_10_9_universal2.whl <span class=o>(</span><span class=m>17</span> kB<span class=o>)</span>
</span></span><span class=line><span class=cl>Installing collected packages: zipp, MarkupSafe, itsdangerous, click, Werkzeug, Jinja2, importlib-metadata, Flask
</span></span><span class=line><span class=cl>Successfully installed Flask-2.2.2 Jinja2-3.1.2 MarkupSafe-2.1.1 Werkzeug-2.2.2 click-8.1.3 importlib-metadata-5.1.0 itsdangerous-2.1.2 zipp-3.11.0
</span></span></code></pre></td></tr></table></div></div><p>Git init</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ git init
</span></span></code></pre></td></tr></table></div></div><p>with <code>.gitignore</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>venv/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*.pyc
</span></span><span class=line><span class=cl>__pycache__/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>instance/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>.pytest_cache/
</span></span><span class=line><span class=cl>.coverage
</span></span><span class=line><span class=cl>htmlcov/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dist/
</span></span><span class=line><span class=cl>build/
</span></span><span class=line><span class=cl>*.egg-info/
</span></span></code></pre></td></tr></table></div></div><p>Add folders</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tree -a -L <span class=m>1</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── .git
</span></span><span class=line><span class=cl>├── .gitignore
</span></span><span class=line><span class=cl>├── flaskr
</span></span><span class=line><span class=cl>├── tests
</span></span><span class=line><span class=cl>└── venv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>4</span> directories, <span class=m>1</span> file
</span></span></code></pre></td></tr></table></div></div><a href=#step-3-application-setup><h3 id=step-3-application-setup><span class=hanchor arialabel=Anchor># </span>Step 3. Application Setup</h3></a><a href=#the-application-factory-__init__py><h4 id=the-application-factory-__init__py><span class=hanchor arialabel=Anchor># </span>The Application Factory: _<em>init</em>_.py</h4></a><ul><li>create <code>Flask</code> instance</li><li>make <code>flaskr</code> directory a package</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl><span class=c1># -*- encoding: utf-8 -*-</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>@Time    :   2022/12/01 15:58:24
</span></span></span><span class=line><span class=cl><span class=s2>@Author  :   Linsan Yang 
</span></span></span><span class=line><span class=cl><span class=s2>@Desc    :   init flaskr
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_app</span><span class=p>(</span><span class=n>test_config</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># create and configure the app</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>instance_relative_config</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>from_mapping</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>SECRET_KEY</span> <span class=o>=</span> <span class=s1>&#39;dev&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>DATABASE</span><span class=o>=</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>instance_path</span><span class=p>,</span> <span class=s1>&#39;flaskr.sqlite&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>test_config</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># load the instance config, if it exists, when not testing</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>from_pyfile</span><span class=p>(</span><span class=s1>&#39;config.py&#39;</span><span class=p>,</span> <span class=n>silent</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># load the test config if passed in</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>from_mapping</span><span class=p>(</span><span class=n>test_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ensure the instance folder exists</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>instance_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>OSError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># a simple page that says hello</span>
</span></span><span class=line><span class=cl>    <span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>hello</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;Hello, World!&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>app</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>instance folder</strong></p><p>There will be a <code>instance/</code>directory, located outside the <code>flaskr</code> package and can hold local data that shouldn’t be committed to version control, such as configuration secrets and the database file.</p><p><strong>test_config</strong></p><p>Using test_config for testing.</p><p><strong>@app.route()</strong></p><p>create a simple route of <code>/hello</code></p><a href=#run-the-application><h4 id=run-the-application><span class=hanchor arialabel=Anchor># </span>Run The Application</h4></a><p>In the <code>flask-tutorial</code> dir not <code>flaskr</code> package:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ flask --app flaskr --debug run
</span></span><span class=line><span class=cl> * Serving Flask app <span class=s1>&#39;flaskr&#39;</span>
</span></span><span class=line><span class=cl> * Debug mode: on
</span></span><span class=line><span class=cl>WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
</span></span><span class=line><span class=cl> * Running on http://127.0.0.1:5000
</span></span><span class=line><span class=cl>Press CTRL+C to quit
</span></span><span class=line><span class=cl> * Restarting with stat
</span></span><span class=line><span class=cl> * Debugger is active!
</span></span><span class=line><span class=cl> * Debugger PIN: 134-914-837
</span></span></code></pre></td></tr></table></div></div><p>Then open 127.0.0.1:5000/hello in browser, got</p><p><img src=https://happy3-data.oss-cn-hangzhou.aliyuncs.com/content-images/image-20221201162507048.png width=auto alt=image-20221201162507048></p><a href=#step-4-define-and-access-the-database><h3 id=step-4-define-and-access-the-database><span class=hanchor arialabel=Anchor># </span>Step 4. Define and Access the Database</h3></a><p>The app will use <code>Sqlite</code> database to store users and posts. Python has a built-in module <code>sqlite3</code> module.</p><a href=#connect-to-sqlite><h4 id=connect-to-sqlite><span class=hanchor arialabel=Anchor># </span>Connect to Sqlite</h4></a><p>flaskr/db.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sqlite3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>click</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>current_app</span><span class=p>,</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_db</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;db&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>g</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>current_app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;DATABASE&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>detect_types</span><span class=o>=</span><span class=n>sqlite3</span><span class=o>.</span><span class=n>PARSE_DECLTYPES</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>row_factory</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>Row</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>g</span><span class=o>.</span><span class=n>db</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>close_db</span><span class=p>(</span><span class=n>e</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>db</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><code>g</code> is a spectial object for each request to share data among different functions. <code>current_app</code> is similar.</p><a href=#create-tables-using-sql><h4 id=create-tables-using-sql><span class=hanchor arialabel=Anchor># </span>Create Tables: using sql</h4></a><p>Define <code>user</code> and <code>post</code> table in <code>flaskr/schema.sql</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>DROP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=k>user</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DROP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>post</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>username</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>password</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>post</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>author_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>created</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>title</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>body</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>author_id</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Add functions to run the SQLs to the <code>db.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>init_db</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span> <span class=o>=</span> <span class=n>get_db</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>current_app</span><span class=o>.</span><span class=n>open_resource</span><span class=p>(</span><span class=s1>&#39;schema.sql&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>executescript</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@click</span><span class=o>.</span><span class=n>command</span><span class=p>(</span><span class=s1>&#39;init-db&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>init_db_command</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;Clear the existing data and create new tables.&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>init_db</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>click</span><span class=o>.</span><span class=n>echo</span><span class=p>(</span><span class=s1>&#39;Initialized the database.&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><a href=#register-with-the-applicaiton><h4 id=register-with-the-applicaiton><span class=hanchor arialabel=Anchor># </span>Register with the Applicaiton</h4></a><p>The close_db and init_db_command functions need to be registered with the app instance for use.</p><p>In <code>db.py</code> add a new <code>init_app</code> function:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>init_app</span><span class=p>(</span><span class=n>app</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># tells Flask to call that function when cleaning up after returning the response</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>teardown_appcontext</span><span class=p>(</span><span class=n>close_db</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># adds a new command that can be called with the flask command</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>cli</span><span class=o>.</span><span class=n>add_command</span><span class=p>(</span><span class=n>init_db_command</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Then import and call this function from the factory in <code>__init__.py</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_app</span><span class=p>(</span><span class=n>test_config</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># create and configure the app</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span> <span class=o>=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1># existing code omitted</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># add db functions</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=n>db</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>init_app</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>app</span>
</span></span></code></pre></td></tr></table></div></div><a href=#initialize-the-database><h4 id=initialize-the-database><span class=hanchor arialabel=Anchor># </span>Initialize the Database</h4></a><p>Now use <code>init-db</code>command like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ flask --app flaskr init-db
</span></span><span class=line><span class=cl>Initialized the database.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ tree instance/
</span></span><span class=line><span class=cl>instance/
</span></span><span class=line><span class=cl>└── flaskr.sqlite
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0</span> directories, <span class=m>1</span> file
</span></span></code></pre></td></tr></table></div></div><p>The command generates a sqlite db file <code>flaskr.sqlite</code> in <code>instance/</code> dir.</p><a href=#step-5-blueprints-and-views><h3 id=step-5-blueprints-and-views><span class=hanchor arialabel=Anchor># </span>Step 5. Blueprints and Views</h3></a><p>Referances:</p><p><a href=https://flask.palletsprojects.com/en/2.2.x/tutorial/views/ rel=noopener>Blueprints and Views</a></p><p><a href="https://realpython.com/flask-blueprint/#:~:text=Flask-is-a-very-popular,its-functionality-into-reusable-components" rel=noopener>Use a Flask Blueprint to Architect Your Applications</a></p><p>Concept: view</p><p>A view is Flask&rsquo;s respond to the outgoing request. Flask uses patterns to match the incoming request URL to the view that should handle it.</p><p>Concept: blueprint</p><p>A blueprint is a way to organize a group of related views and other code. Rather than registering views and other code directly with an application, they are registered with a blueprint. Then the blueprint is registered with the application when it is available in the factory function.</p><a href=#create-a-blueprint><h4 id=create-a-blueprint><span class=hanchor arialabel=Anchor># </span>Create a Blueprint</h4></a><p>Flaskr will have two blueprints:</p><ul><li>auth functions</li><li>blog posts functions</li></ul><p><code>Flaskr/auth.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Blueprint</span><span class=p>,</span> <span class=n>flash</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>redirect</span><span class=p>,</span> <span class=n>render_template</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>session</span><span class=p>,</span> <span class=n>url_for</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>werkzeug.security</span> <span class=kn>import</span> <span class=n>check_password_hash</span><span class=p>,</span> <span class=n>generate_password_hash</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flaskr.db</span> <span class=kn>import</span> <span class=n>get_db</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bp</span> <span class=o>=</span> <span class=n>Blueprint</span><span class=p>(</span><span class=s1>&#39;auth&#39;</span><span class=p>,</span> <span class=vm>__name__</span><span class=p>,</span> <span class=n>url_prefix</span><span class=o>=</span><span class=s1>&#39;/auth&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>A new <code>Blueprint</code> is created:</p><ul><li>with <code>name</code>: &lsquo;auth&rsquo;</li><li>with <code>import_name</code>: &lsquo;_<em>name</em>_&rsquo;, helping the blueprint to know where it’s defined</li><li>with <code>url_prefix</code>: will be prepended (added at head)to all the URLs associated with this blueprint.</li></ul><p>Then register the blueprint to the app from the factory in the <code>__init__.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_app</span><span class=p>(</span><span class=n>test_config</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># create and configure the app</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span> <span class=o>=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1># existing code omitted</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># add auth blueprint</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=n>auth</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>register_blueprint</span><span class=p>(</span><span class=n>auth</span><span class=o>.</span><span class=n>bp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>app</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Referances:</p><p><a href=https://docs.python.org/3/library/functools.html rel=noopener>Python functools</a></p></blockquote><a href=#register-view><h4 id=register-view><span class=hanchor arialabel=Anchor># </span>Register view</h4></a><p>When the user visits the <code>/auth/register</code> URL, the <code>register</code> view will return
<a href=https://developer.mozilla.org/docs/Web/HTML rel=noopener>HTML</a> with a form for them to fill out. When they submit the form, it will validate their input and either show the form again with an error message or create the new user and go to the login page.</p><p>The view code is as following in <code>flaskr/auth.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@bp</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/register&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>register</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span> <span class=o>=</span> <span class=n>get_db</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>username</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>error</span> <span class=o>=</span> <span class=s1>&#39;Username is required.&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=ow>not</span> <span class=n>password</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>error</span> <span class=o>=</span> <span class=s1>&#39;Password is required.&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>error</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;INSERT INTO user (username, password) VALUES (?, ?)&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>generate_password_hash</span><span class=p>(</span><span class=n>password</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>db</span><span class=o>.</span><span class=n>IntegrityError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>error</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;User </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2> is already registered.&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;auth.login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>flash</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;auth/register.html&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>register</code> view works as following:</p><ul><li>@bp.route associates the URL <code>/register</code> with the <code>register</code> view.</li><li>If the user submited the register form, <code>request.method == 'POST'</code>, then validate the input <code>username</code> and <code>password</code> and store them into the database.</li><li>If storing the user info succeeds, then redirect to the <code>auth.login</code> page.</li><li>If the user is initially landing on the <code>register</code> page, or there was a validation error, the <code>register.html</code> will be shown.</li></ul><a href=#login-view><h4 id=login-view><span class=hanchor arialabel=Anchor># </span>Login view</h4></a><p>This view follows the same pattern as <code>register</code> view.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=nd>@bp</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span> <span class=o>=</span> <span class=n>get_db</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;SELECT * FROM user WHERE username = ?&#39;</span><span class=p>,</span> <span class=p>(</span><span class=n>username</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>user</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>error</span> <span class=o>=</span> <span class=s1>&#39;Incorrect username.&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=ow>not</span> <span class=n>check_password_hash</span><span class=p>(</span><span class=n>user</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>],</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>error</span> <span class=o>=</span> <span class=s1>&#39;Incorrect password.&#39;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>error</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>user</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>flash</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;auth/login.html&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Tips:</p><ul><li>The user info is queried and stored in <code>user</code> variable using <code>fetch_one</code> function.</li><li>Validate the <code>username</code> and <code>password</code> (by <code>check_password_hash</code>) inputs.</li><li>The <code>session</code> (a dict storing data across requests) refreshes if login succeeds. (The data is stored in a <em>cookie</em> that is sent to the browser, and the browser then sends it back with subsequent requests.)</li></ul><p>We can get user info at the beginning of each request via <code>session</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@bp</span><span class=o>.</span><span class=n>before_app_request</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_logged_in_user</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>user_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=o>.</span><span class=n>user</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=o>.</span><span class=n>user</span> <span class=o>=</span> <span class=n>get_db</span><span class=p>()</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;SELECT * FROM user WHERE id = ?&#39;</span><span class=p>,</span> <span class=p>(</span><span class=n>user_id</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Tips:</p><ul><li><a href=https://flask.palletsprojects.com/en/2.2.x/api/#flask.Blueprint.before_app_request rel=noopener><code>bp.before_app_request()</code></a> registers a function that runs before the view function, no matter what URL is requested.</li><li><code>load_logged_in_user</code> gets that user info from the database via <code>session</code> and stores it on
<a href=https://flask.palletsprojects.com/en/2.2.x/api/#flask.g rel=noopener><code>g.user</code></a>, which lasts for the length of the request.</li></ul><a href=#logout-view><h4 id=logout-view><span class=hanchor arialabel=Anchor># </span>Logout view</h4></a><p>The Logout view removes the user id from the
<a href=https://flask.palletsprojects.com/en/2.2.x/api/#flask.session rel=noopener><code>session</code></a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@bp</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>logout</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><a href=#require-auth-in-other-views><h4 id=require-auth-in-other-views><span class=hanchor arialabel=Anchor># </span>Require Auth in Other views</h4></a><p>Creating, editing and deleting blog posts requires the user to be logged in. Use a <strong>decorator</strong> to achieve this.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>login_required</span><span class=p>(</span><span class=n>view</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@functools</span><span class=o>.</span><span class=n>wraps</span><span class=p>(</span><span class=n>view</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapped_view</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>g</span><span class=o>.</span><span class=n>user</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;auth.login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>view</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapped_view</span> 
</span></span></code></pre></td></tr></table></div></div><p>This decorator wraps the view in this way: if a user is not logged in, then redirect to login page; if logged in, return the orginal view.</p><a href=#step-6-templates><h3 id=step-6-templates><span class=hanchor arialabel=Anchor># </span>Step 6. Templates</h3></a></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/digital-garden/notes/python-programming/ data-ctx="Hands on Flask" data-src=/notes/python-programming class=internal-link>Python Programming</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://yangls06.github.io/digital-garden/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by yangls06 using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2022</p><ul><li><a href=https://yangls06.github.io/digital-garden/>Home</a></li><li><a href=https://github.com/yangls06>Github</a></li></ul></footer></div></div></body></html>